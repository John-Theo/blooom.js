class Blooom{constructor(t,e,r){let n;[e,n]=this.transformData(e),this.config=new Config(this,n,r),this.handler=new Handler(this),this.renderer=new Renderer;const[o,i]=this.washData(e);this.container=this.initCanvas(t),this.simulation=this.initSimulation(o,i),this.links=this.initLinks(i),this.nodes=this.initNodes(o),this.registerInteraction(i),this.renderTick()}loadNeo4j(t){let e=[],r=[];return t.map(t=>t.graph).forEach(t=>{e=e.concat(t.nodes),r=r.concat(t.relationships)}),[{nodes:e,links:r},{linkSourceKey:"startNode",linkTargetKey:"endNode",nodeGroupsKey:"labels"}]}transformData(t){let e={};return"string"==typeof t&&(t=JSON.parse(t)),t[0].graph&&([t,e]=this.loadNeo4j(t)),[t,e]}washData(t){let e=[];const r=renameItemDict(t.links,{source:this.config.linkSourceKey,target:this.config.linkTargetKey}).map(t=>(e.push(t.source),e.push(t.target),Object.create(t)));e=unique(e);let n=[],o=[];const i=renameItemDict(t.nodes,{labels:this.config.nodeGroupsKey}).map(t=>n.indexOf(t.id)>=0||e.indexOf(t.id)<0?null:(n.push(t.id),o.push(t[this.config.nodeGroupsKey]),Object.create(t))).filter(t=>t);return this.existedGroups=Object.assign(...unique(o.flat()).map((t,e)=>({[t]:e}))),[i,r]}initCanvas(t){return this.svg=d3.select(t).html("").append("svg").attr("id","blooom").attr("width","100%").attr("height","100%"),this.width=this.svg.node().clientWidth,this.height=this.svg.node().clientHeight,this.svg.attr("viewBox",[0,0,this.width,this.height]),this.svg.append("g")}initSimulation(t,e){return d3.forceSimulation(t).velocityDecay(.1).force("link",d3.forceLink(e).id(t=>t.id)).force("charge",d3.forceManyBody().strength(-800)).force("center",d3.forceCenter(this.width/2,this.height/2)).force("collide",d3.forceCollide().radius(40).iterations(2))}initNodes(t){const e=this.container.selectAll(".node").data(t).enter().append("g").attr("class","node").call(this.handler.drag(this.simulation));return this.nodeGroup={circle:e.append("circle").attr("class","glow").attr("r",25),glow:e.append("circle").attr("class","circle").attr("r",25).attr("fill",t=>this.config.colors[this.config.getNodeClassIndex(t.labels)]).attr("stroke",t=>this.config.borderColors[this.config.getNodeClassIndex(t.labels)]),label:e.append("text").text(t=>this.config.getNodeText(t))},e}initLinks(t){var e=this.container.selectAll(".link").data(t).enter().append("g").attr("class","link");return this.linkGroup={glow:e.append("path").attr("class","glow"),arrow:e.append("path").attr("class","arrow"),text:e.append("text").text(t=>t[this.config.linkLabelProperty])},e}registerInteraction(t){const e=this;this.nodesLinked=[],t.forEach((function(t){e.nodesLinked[t.source.index+"-"+t.target.index]=!0,e.nodesLinked[t.target.index+"-"+t.source.index]=!0})),this.links.on("mouseenter",(function(t){e.handler.focusLink(t),e.config.linkMouseEnter&&e.config.linkMouseEnter(t,e)})).on("mouseleave",(function(t){e.handler.removeFocus(e.nodes,e.links),e.config.linkMouseLeave&&e.config.linkMouseLeave(t,e)})),this.nodes.on("contextmenu",t=>{e.handler.pinNode(e.nodes,t),t.fx=t.x,t.fy=t.y}).on("mouseenter",(function(t){e.handler.focusNode(t),e.config.nodeMouseEnter&&e.config.nodeMouseEnter(t,e)})).on("mouseleave",(function(t){e.handler.removeFocus(e.nodes,e.links),e.config.nodeMouseLeave&&e.config.nodeMouseLeave(t,e)})),this.svg.on("contextmenu",()=>d3.event.preventDefault()).call(this.handler.zoom()),this.svg.on("dblclick.zoom",null)}renderTick(){this.simulation.on("tick",()=>{this.renderer.renderLink(this.links,this.linkGroup.glow,this.linkGroup.text),this.nodes.attr("transform",t=>`translate(${t.x}, ${t.y})`)})}}class Config{nodeMouseEnter=null;nodeMouseLeave=null;linkMouseEnter=null;linkMouseLeave=null;colors=["#68bdf6","#6dce9e","#faafc2","#f2baf6","#ff928c","#fcea7e","#ffc766","#405f9e","#a5abb6","#78cecb","#b88cbb","#ced2d9","#e84646","#fa5f86","#ffab1a","#fcda19","#797b80","#c9d96f","#47991f","#70edee","#ff75ea"];linkSourceKey="source";linkTargetKey="target";nodeGroupsKey="group";linkLabelProperty="type";nodeLabelProperties=null;constructor(t,...e){const r=this;if(e)for(let t of e)Object.entries(t).forEach(([t,e])=>r[t]=e);this.graph=t,this.borderColors=this.colors.map(t=>d3.rgb(t).darker(.5))}getNodeLabel(t){return t.constructor===Array?t[0]:t}getNodeClassIndex(t){return this.graph.existedGroups[this.getNodeLabel(t)]}getNodeText(t){return t.properties[this.nodeLabelProperties[this.getNodeLabel(t.labels)]]}}class Handler{constructor(t){this.graph=t}focusLink(t){this.graph.nodes.each((function(e){e.index!=t.source.index&&e.index!=t.target.index&&this.classList.add("faded")})),this.graph.links.each((function(e){e.source.index==t.source.index&&e.target.index==t.target.index||this.classList.add("faded")}))}focusNode(t){const e=this;this.graph.nodes.each((function(r){r.index==t.index||e.graph.nodesLinked[r.index+"-"+t.index]||this.classList.add("faded")})),this.graph.links.each((function(e){e.source.index!=t.index&&e.target.index!=t.index&&this.classList.add("faded")}))}removeFocus(){this.graph.nodes.each((function(){this.classList.remove("faded")})),this.graph.links.each((function(){this.classList.remove("faded")}))}pinNode(t,e){this.graph.nodes.each((function(t){t.index===e.index&&this.classList.add("pinned")}))}removeNodePin(t){this.graph.nodes.each((function(e){e.index===t.index&&this.classList.remove("pinned")}))}zoom(){const t=this;return d3.zoom().scaleExtent([.1,2]).on("zoom",()=>{const e=+d3.event.transform.k;t.graph.nodeGroup.label.attr("opacity",e>.5?1:e<.4?0:10*(e-.4)),t.graph.linkGroup.text.attr("opacity",e>.5?1:e<.4?0:10*(e-.4)),t.graph.container.attr("transform",d3.event.transform)})}drag(t){const e=this;return d3.drag().on("start",(function(r){d3.event.active||t.alphaTarget(.3).restart(),e.removeNodePin(r),r.fx=r.x,r.fy=r.y})).on("drag",(function(t){t.fx=d3.event.x,t.fy=d3.event.y})).on("end",(function(e){d3.event.active||t.alphaTarget(0),e.fx=null,e.fy=null}))}}class Renderer{utils=new Utils;renderLink(t,e,r){const n=this;t.attr("transform",(function(t){var e=n.utils.rotation(t.source,t.target);return"translate("+t.source.x+", "+t.source.y+") rotate("+e+")"}));this.renderLinkText(r),this.renderLinkGlow(e),this.renderLinkArrow(t,{nodeRadius:25,arrowSize:4})}renderLinkArrow(t,e){const r=this;t.each((function(){var t=d3.select(this),n=t.select(".arrow"),o=t.select("text");n.attr("d",(function(t){var n={x:0,y:0},i=r.utils.rotation(t.source,t.target),s=o.node().getBBox(),a=r.utils.unitaryVector(t.source,t.target),d={x:.5*(t.target.x-t.source.x-(s.width+5)*a.x),y:.5*(t.target.y-t.source.y-(s.width+5)*a.y)},c=r.utils.unitaryNormalVector(t.source,t.target),l=r.utils.rotatePoint(n,{x:0+(e.nodeRadius+1)*a.x-c.x,y:0+(e.nodeRadius+1)*a.y-c.y},i),u=r.utils.rotatePoint(n,{x:d.x-c.x,y:d.y-c.y},i),h=r.utils.rotatePoint(n,{x:d.x,y:d.y},i),x=r.utils.rotatePoint(n,{x:0+(e.nodeRadius+1)*a.x,y:0+(e.nodeRadius+1)*a.y},i),y=r.utils.rotatePoint(n,{x:t.target.x-t.source.x-d.x-c.x,y:t.target.y-t.source.y-d.y-c.y},i),g=r.utils.rotatePoint(n,{x:t.target.x-t.source.x-(e.nodeRadius+1)*a.x-c.x-a.x*e.arrowSize,y:t.target.y-t.source.y-(e.nodeRadius+1)*a.y-c.y-a.y*e.arrowSize},i),f=r.utils.rotatePoint(n,{x:t.target.x-t.source.x-(e.nodeRadius+1)*a.x-c.x+(c.x-a.x)*e.arrowSize,y:t.target.y-t.source.y-(e.nodeRadius+1)*a.y-c.y+(c.y-a.y)*e.arrowSize},i),p=r.utils.rotatePoint(n,{x:t.target.x-t.source.x-(e.nodeRadius+1)*a.x,y:t.target.y-t.source.y-(e.nodeRadius+1)*a.y},i),k=r.utils.rotatePoint(n,{x:t.target.x-t.source.x-(e.nodeRadius+1)*a.x+(-c.x-a.x)*e.arrowSize,y:t.target.y-t.source.y-(e.nodeRadius+1)*a.y+(-c.y-a.y)*e.arrowSize},i),m=r.utils.rotatePoint(n,{x:t.target.x-t.source.x-(e.nodeRadius+1)*a.x-a.x*e.arrowSize,y:t.target.y-t.source.y-(e.nodeRadius+1)*a.y-a.y*e.arrowSize},i),L=r.utils.rotatePoint(n,{x:t.target.x-t.source.x-d.x,y:t.target.y-t.source.y-d.y},i);return"M "+l.x+" "+l.y+" L "+u.x+" "+u.y+" L "+h.x+" "+h.y+" L "+x.x+" "+x.y+" Z M "+y.x+" "+y.y+" L "+g.x+" "+g.y+" L "+f.x+" "+f.y+" L "+p.x+" "+p.y+" L "+k.x+" "+k.y+" L "+m.x+" "+m.y+" L "+L.x+" "+L.y+" Z"}))}))}renderLinkGlow(t){const e=this;t.attr("d",(function(t){var r={x:0,y:0},n=e.utils.rotation(t.source,t.target),o=e.utils.unitaryNormalVector(t.source,t.target),i=e.utils.rotatePoint(r,{x:0-o.x,y:0-o.y},n),s=e.utils.rotatePoint(r,{x:t.target.x-t.source.x-o.x,y:t.target.y-t.source.y-o.y},n),a=e.utils.rotatePoint(r,{x:t.target.x-t.source.x,y:t.target.y-t.source.y},n),d=e.utils.rotatePoint(r,{x:0,y:0},n);return"M "+i.x+" "+i.y+" L "+s.x+" "+s.y+" L "+a.x+" "+a.y+" L "+d.x+" "+d.y+" Z"}))}renderLinkText(t){const e=this;t.attr("transform",(function(t){var r=(e.utils.rotation(t.source,t.target)+360)%360,n=r>90&&r<270,o=e.utils.unitaryNormalVector(t.source,t.target),i=n?2:-3,s={x:.5*(t.target.x-t.source.x)+o.x*i,y:.5*(t.target.y-t.source.y)+o.y*i},a=e.utils.rotatePoint({x:0,y:0},s,r);return"translate("+a.x+", "+a.y+") rotate("+(n?180:0)+")"}))}}const unique=t=>t.filter((t,e,r)=>r.indexOf(t)===e);function renameItemDict(t,e){return t.map(t=>Object.entries(e).map(([e,r])=>(e===r||(Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(t,r)),delete t[r]),t))[0])}class Utils{rotation(t,e){return 180*Math.atan2(e.y-t.y,e.x-t.x)/Math.PI}unitaryVector(t,e,r){var n=Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2))/Math.sqrt(r||1);return{x:(e.x-t.x)/n,y:(e.y-t.y)/n}}unitaryNormalVector(t,e,r){var n=this.unitaryVector(t,e,r);return this.rotatePoint({x:0,y:0},n,90)}rotate(t,e,r,n,o){var i=Math.PI/180*o,s=Math.cos(i),a=Math.sin(i);return{x:s*(r-t)+a*(n-e)+t,y:s*(n-e)-a*(r-t)+e}}rotatePoint(t,e,r){return this.rotate(t.x,t.y,e.x,e.y,r)}}
//# sourceMappingURL=main.es.browser.js.map
